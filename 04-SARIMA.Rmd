# Modelado ARIMA: Metodología Box-Jenkins {#sarima}

Los modelos ARIMA (AutoRegressive Integrated Moving Average) representan una familia de modelos estadísticos para series temporales que capturan diferentes aspectos de la autocorrelación en los datos. Cuando la serie presenta estacionalidad, se extiende a SARIMA (Seasonal ARIMA), incorporando componentes estacionales adicionales.

**Nota**: Los datos y el modelo SARIMA fueron preparados en el Capítulo \@ref(preparacion). Los objetos `sarima_model`, `sarima_forecast`, `ts_train_regular`, `ts_test_regular` y las métricas están disponibles directamente.

## Resumen del Modelo Ajustado

```{r resumen-sarima}
cat("=== MODELO SARIMA ===\n\n")
cat("Partición de datos:\n")
cat("  Entrenamiento: 1972-07 a 1997-12 | n =", length(ts_train_regular), "\n")
cat("  Prueba: 1998-01 a 1998-12 | n =", length(ts_test_regular), "\n\n")

# Extraer orden del modelo de forma segura
orden <- arimaorder(sarima_model)
if(length(orden) >= 6) {
  cat("Orden identificado: SARIMA(", orden[1], ",", orden[2], ",", orden[3], 
      ")(", orden[4], ",", orden[5], ",", orden[6], ")[12]\n\n", sep="")
} else {
  cat("Orden identificado: ARIMA(", orden[1], ",", orden[2], ",", orden[3], ")\n\n", sep="")
}

cat("Métricas de pronóstico (1998):\n")
cat("  MAE:", round(MAE_sarima, 3), "mm\n")
cat("  RMSE:", round(RMSE_sarima, 3), "mm\n")
cat("  MAPE:", round(MAPE_sarima, 2), "%\n")
cat("  Cobertura IC:", round(cobertura_sarima, 1), "%\n")
```

## Especificación del Modelo SARIMA

La metodología Box-Jenkins utiliza los criterios de información (AIC, AICc, BIC) para seleccionar el modelo óptimo. El modelo fue seleccionado automáticamente en el Capítulo \@ref(preparacion) evaluando sistemáticamente múltiples especificaciones SARIMA(p,d,q)(P,D,Q)[12].

**Notación del modelo SARIMA(p,d,q)(P,D,Q)[m]:**

- **p**: Orden del componente autorregresivo (AR)
- **d**: Orden de diferenciación regular
- **q**: Orden del componente de media móvil (MA)
- **P**: Orden del componente autorregresivo estacional (SAR)
- **D**: Orden de diferenciación estacional
- **Q**: Orden del componente de media móvil estacional (SMA)
- **m**: Período estacional (12 para datos mensuales)

```{r especificacion-sarima}
cat("=== MODELO SELECCIONADO ===\n\n")
print(summary(sarima_model))

# Extraer orden del modelo
orden <- arimaorder(sarima_model)

cat("\n=== ESPECIFICACIÓN DEL MODELO ===\n\n")
if(length(orden) >= 6) {
  cat("Modelo seleccionado: SARIMA", 
      paste0("(", orden[1], ",", orden[2], ",", orden[3], ")"),
      paste0("(", orden[4], ",", orden[5], ",", orden[6], ")[12]"), "\n\n")
} else {
  cat("Modelo seleccionado: ARIMA",
      paste0("(", orden[1], ",", orden[2], ",", orden[3], ")"), "\n\n")
}

cat("Criterios de información:\n")
cat("  AIC:  ", round(sarima_model$aic, 2), "\n")
cat("  AICc: ", round(sarima_model$aicc, 2), "\n")
cat("  BIC:  ", round(sarima_model$bic, 2), "\n\n")

cat("Varianza de los residuos (sigma^2):", round(sarima_model$sigma2, 4), "\n")
```

## Análisis Comparativo: Serie Original vs. Valores Ajustados

```{r comparacion-original-sarima, fig.width=12, fig.height=8}
# Extraer valores ajustados (fitted values) del modelo SARIMA
valores_ajustados_sarima <- fitted(sarima_model)

# Crear dataframe para comparación
comparacion_sarima <- data.frame(
  Fecha = index(ts_train),
  Original = coredata(ts_train),
  Ajustado = as.numeric(valores_ajustados_sarima)
)

# Gráfico comparativo
ggplot(comparacion_sarima, aes(x = Fecha)) +
  geom_line(aes(y = Original, color = "Serie Original"), alpha = 0.5, linewidth = 0.7) +
  geom_line(aes(y = Ajustado, color = "SARIMA Ajustado"), linewidth = 1.0) +
  scale_color_manual(
    values = c("Serie Original" = "black", "SARIMA Ajustado" = "red")
  ) +
  labs(
    title = "Comparación: Serie Original vs. Valores Ajustados SARIMA",
    subtitle = paste0("Modelo ", 
                     ifelse(length(arimaorder(sarima_model)) >= 6,
                            paste0("SARIMA(", paste(arimaorder(sarima_model)[1:3], collapse=","), ")",
                                   "(", paste(arimaorder(sarima_model)[4:6], collapse=","), ")[12]"),
                            paste0("ARIMA(", paste(arimaorder(sarima_model)[1:3], collapse=","), ")")),
                     " aplicado al conjunto de entrenamiento (1972-1997)"),
    x = "Fecha",
    y = "Precipitación (mm)",
    color = ""
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "bottom"
  )

# Estadísticas de ajuste
cat("\n=== CALIDAD DEL AJUSTE ===\n\n")
cat("Correlación entre serie original y valores ajustados:", 
    round(cor(comparacion_sarima$Original, comparacion_sarima$Ajustado, use = "complete.obs"), 4), "\n")
cat("R² (porcentaje de varianza explicada):", 
    round(cor(comparacion_sarima$Original, comparacion_sarima$Ajustado, use = "complete.obs")^2 * 100, 2), "%\n")

# Error cuadrático medio in-sample
mse_insample <- mean((comparacion_sarima$Original - comparacion_sarima$Ajustado)^2, na.rm = TRUE)
cat("Error cuadrático medio (MSE) in-sample:", round(mse_insample, 4), "\n")
cat("Raíz del error cuadrático medio (RMSE) in-sample:", round(sqrt(mse_insample), 3), "mm\n")
```

**Interpretación del gráfico:**

- **Línea gris**: Datos observados de precipitación mensual
- **Línea roja**: Valores ajustados por el modelo SARIMA

El modelo captura exitosamente:
- Las variaciones interanuales de la precipitación
- La estructura de autocorrelación temporal

Las discrepancias entre ambas líneas representan los **residuos**, que idealmente deben comportarse como ruido blanco (sin patrón sistemático).

## Interpretación de Componentes del Modelo

```{r interpretar-componentes}
orden <- arimaorder(sarima_model)

cat("=== INTERPRETACIÓN DE COMPONENTES ===\n\n")

# Componentes no estacionales
if(!is.na(orden[1]) && orden[1] > 0) {
  cat("AR(", orden[1], "): La serie depende de sus valores pasados recientes\n", sep="")
  coef_ar <- sarima_model$coef[grep("^ar[0-9]", names(sarima_model$coef))]
  if(length(coef_ar) > 0) {
    cat("  Coeficientes AR:", round(coef_ar, 4), "\n")
  }
}

if(!is.na(orden[2]) && orden[2] > 0) {
  cat("Diferenciación regular (d=", orden[2], "): Se aplicó diferenciación para estacionaridad\n", sep="")
} else {
  cat("No se requiere diferenciación regular (d=0): Serie ya estacionaria\n")
}

if(!is.na(orden[3]) && orden[3] > 0) {
  cat("MA(", orden[3], "): La serie depende de shocks aleatorios pasados\n", sep="")
  coef_ma <- sarima_model$coef[grep("^ma[0-9]", names(sarima_model$coef))]
  if(length(coef_ma) > 0) {
    cat("  Coeficientes MA:", round(coef_ma, 4), "\n")
  }
}

cat("\n")

# Componentes estacionales (verificar si existen antes de acceder)
if(length(orden) >= 6) {
  if(!is.na(orden[4]) && orden[4] > 0) {
    cat("SAR(", orden[4], "): Dependencia con el mismo mes del año anterior\n", sep="")
    coef_sar <- sarima_model$coef[grep("^sar[0-9]", names(sarima_model$coef))]
    if(length(coef_sar) > 0) {
      cat("  Coeficientes SAR:", round(coef_sar, 4), "\n")
    }
  }
  
  if(!is.na(orden[5]) && orden[5] > 0) {
    cat("Diferenciación estacional (D=", orden[5], "): Se eliminó tendencia estacional\n", sep="")
  } else {
    cat("No se requiere diferenciación estacional (D=0)\n")
  }
  
  if(!is.na(orden[6]) && orden[6] > 0) {
    cat("SMA(", orden[6], "): Efectos estacionales de shocks pasados\n", sep="")
    coef_sma <- sarima_model$coef[grep("^sma[0-9]", names(sarima_model$coef))]
    if(length(coef_sma) > 0) {
      cat("  Coeficientes SMA:", round(coef_sma, 4), "\n")
    }
  }
} else {
  cat("Nota: El modelo seleccionado no tiene componentes estacionales explícitos\n")
}

cat("\n=== SIGNIFICANCIA ESTADÍSTICA ===\n\n")

# Test de significancia de coeficientes
if(requireNamespace("lmtest", quietly = TRUE)) {
  coef_test <- lmtest::coeftest(sarima_model)
  print(coef_test)
  cat("\nInterpretación: Coeficientes con p-valor < 0.05 son estadísticamente significativos\n")
} else {
  cat("Paquete 'lmtest' no disponible. Mostrando solo coeficientes:\n")
  print(summary(sarima_model)$coef)
}
```

## Diagnóstico de Residuos

Un buen modelo ARIMA debe producir residuos que se comporten como ruido blanco (sin autocorrelación, media cero, varianza constante, distribución normal).

```{r diagnostico-residuos-sarima, fig.width=12, fig.height=10}
# Función checkresiduals proporciona diagnóstico integral
# Genera automáticamente: serie temporal, ACF, histograma y test de Ljung-Box
checkresiduals(sarima_model)
```

**Interpretación de los gráficos:**

1. **Residuos a lo largo del tiempo**: Deben fluctuar aleatoriamente alrededor de cero sin patrones sistemáticos
2. **ACF de residuos**: Todas las barras deben estar dentro de las bandas azules (no autocorrelación)
3. **Histograma**: Debe aproximarse a una distribución normal centrada en cero

```{r tests-estadisticos-residuos}
cat("=== TESTS ESTADÍSTICOS DE RESIDUOS ===\n\n")

# Test de Ljung-Box (autocorrelación residual)
ljung_box <- Box.test(sarima_residuos, lag = 20, type = "Ljung-Box")

cat("Test de Ljung-Box (autocorrelación):\n")
cat("  Estadístico:", round(ljung_box$statistic, 4), "\n")
cat("  P-valor:", round(ljung_box$p.value, 4), "\n")

if(ljung_box$p.value > 0.05) {
  cat("  ✓ Conclusión: No hay autocorrelación significativa (p > 0.05)\n")
  cat("    Los residuos se comportan como ruido blanco\n\n")
} else {
  cat("  ✗ Conclusión: Hay autocorrelación residual (p < 0.05)\n")
  cat("    El modelo podría mejorarse\n\n")
}

# Test de normalidad
shapiro_residuos <- shapiro.test(sarima_residuos)

cat("Test de Shapiro-Wilk (normalidad):\n")
cat("  Estadístico W:", round(shapiro_residuos$statistic, 4), "\n")
cat("  P-valor:", round(shapiro_residuos$p.value, 4), "\n")

if(shapiro_residuos$p.value > 0.05) {
  cat("  ✓ Conclusión: Los residuos siguen distribución normal (p > 0.05)\n\n")
} else {
  cat("  ⚠ Conclusión: Los residuos NO siguen distribución normal estricta (p < 0.05)\n")
  cat("    Esto puede afectar la validez de los intervalos de confianza\n\n")
}

# Estadísticas descriptivas
cat("Estadísticas de residuos:\n")
cat("  Media:", round(mean(sarima_residuos, na.rm = TRUE), 4), "mm (ideal: ~0)\n")
cat("  Desviación estándar:", round(sd(sarima_residuos, na.rm = TRUE), 3), "mm\n")
cat("  Rango: [", round(min(sarima_residuos, na.rm = TRUE), 2), ",", 
    round(max(sarima_residuos, na.rm = TRUE), 2), "] mm\n")
```

## Pronóstico para 1998

Generamos el pronóstico para el año 1998 (12 meses) y comparamos con los valores observados.

```{r pronostico-sarima, fig.width=12, fig.height=8}
# Generar pronóstico para 12 meses
sarima_forecast <- forecast(sarima_model, h = 12, level = 95)

# Crear dataframe para visualización
datos_forecast_sarima <- data.frame(
  Fecha = index(ts_test),
  Observado = as.numeric(coredata(ts_test)),
  Pronostico = as.numeric(sarima_forecast$mean),
  IC_inferior = as.numeric(sarima_forecast$lower[, 1]),
  IC_superior = as.numeric(sarima_forecast$upper[, 1])
)

# Gráfico de pronóstico vs observado
ggplot(datos_forecast_sarima, aes(x = Fecha)) +
  # Intervalo de confianza
  geom_ribbon(aes(ymin = IC_inferior, ymax = IC_superior),
              fill = "red", alpha = 0.1) +
  # Línea de pronóstico
  geom_line(aes(y = Pronostico, color = "Pronóstico SARIMA"),
            linewidth = 1.2) +
  # Valores observados
  geom_line(aes(y = Observado, color = "Observado"),
            linewidth = 1.0) +
  geom_point(aes(y = Observado, color = "Observado"),
             size = 2.5) +
  scale_color_manual(
    values = c("Pronóstico SARIMA" = "red", "Observado" = "black")
  ) +
  labs(
    title = "Pronóstico SARIMA vs. Valores Observados (1998)",
    subtitle = paste("Modelo:", paste0("SARIMA(", paste(orden[1:3], collapse=","), ")"),
                     paste0("(", paste(orden[4:6], collapse=","), ")[12]"),
                     "| IC 95%"),
    x = "Fecha",
    y = "Precipitación (mm)",
    color = ""
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "bottom"
  )
```

Como se observa en el gráfico, el modelo SARIMA captura efectivamente el **comportamiento estacional** de la precipitación mensual en Cali, reproduciendo el **patrón bimodal** característico de la región con dos períodos de máxima precipitación en **abril-mayo** y **octubre-noviembre**, separados por períodos de menor precipitación. El pronóstico (línea roja) sigue de cerca la trayectoria de los valores observados.

La **banda roja translúcida** representa el intervalo de confianza al 95%, que cuantifica la incertidumbre inherente al pronóstico. Es notable que en algunos meses el intervalo es más amplio (mayor incertidumbre) que en otros, reflejando la variabilidad natural de la precipitación. La estructura del modelo SARIMA permite que esta incertidumbre se adapte a las características específicas de cada período.

## Evaluación del Desempeño del Modelo

```{r metricas-sarima}
# Calcular errores de pronóstico
errores_sarima <- datos_forecast_sarima$Observado - datos_forecast_sarima$Pronostico

# Métricas de precisión
MAE_sarima <- mean(abs(errores_sarima))
RMSE_sarima <- sqrt(mean(errores_sarima^2))

# MAPE con manejo de valores cercanos a cero
MAPE_sarima <- mean(abs(errores_sarima / pmax(datos_forecast_sarima$Observado, 0.1))) * 100

cat("=== MÉTRICAS DE DESEMPEÑO DEL PRONÓSTICO SARIMA ===\n\n")
cat("Error Absoluto Medio (MAE):", round(MAE_sarima, 3), "mm\n")
cat("Raíz del Error Cuadrático Medio (RMSE):", round(RMSE_sarima, 3), "mm\n")
cat("Error Porcentual Absoluto Medio (MAPE):", round(MAPE_sarima, 2), "%\n\n")

# Análisis de cobertura del intervalo de confianza
dentro_IC_sarima <- sum(datos_forecast_sarima$Observado >= datos_forecast_sarima$IC_inferior & 
                         datos_forecast_sarima$Observado <= datos_forecast_sarima$IC_superior)
cobertura_sarima <- (dentro_IC_sarima / nrow(datos_forecast_sarima)) * 100

cat("Cobertura del intervalo de confianza (95%):", round(cobertura_sarima, 1), "%\n")
cat("  Observaciones dentro del IC:", dentro_IC_sarima, "de", nrow(datos_forecast_sarima), "\n\n")

# Test de normalidad de errores de pronóstico
shapiro_errores <- shapiro.test(errores_sarima)

cat("Test de Shapiro-Wilk (normalidad de errores de pronóstico):\n")
cat("  Estadístico W:", round(shapiro_errores$statistic, 4), "\n")
cat("  P-valor:", round(shapiro_errores$p.value, 4), "\n")

if(shapiro_errores$p.value > 0.05) {
  cat("  Conclusión: Los errores siguen distribución normal (p > 0.05)\n")
} else {
  cat("  Conclusión: Los errores NO siguen distribución normal (p < 0.05)\n")
}

cat("\n=== ESTADÍSTICAS DE ERRORES ===\n\n")
cat("Media de errores:", round(mean(errores_sarima), 4), "mm\n")
cat("  (Sesgo: valor cercano a 0 indica predicciones no sesgadas)\n\n")
cat("Desviación estándar de errores:", round(sd(errores_sarima), 3), "mm\n")
cat("Error mínimo:", round(min(errores_sarima), 3), "mm\n")
cat("Error máximo:", round(max(errores_sarima), 3), "mm\n")
```

**Análisis de las métricas:**

El modelo SARIMA presenta un **desempeño muy similar** al de Holt-Winters, con métricas comparables:

- **MAE = 4.067 mm**: Error absoluto medio prácticamente idéntico al de Holt-Winters (4.016 mm), con una diferencia de apenas 0.05 mm. Ambos modelos logran precisiones equivalentes.

- **RMSE = 5.036 mm**: Ligeramente superior al RMSE de Holt-Winters (4.585 mm), diferencia de 0.45 mm. La relación RMSE/MAE ≈ 1.24 confirma ausencia de errores atípicos extremos.

- **Cobertura del IC = 91.7%**: 11 de 12 observaciones dentro del IC 95%, ligeramente inferior a HW (100%) pero cercana a la cobertura teórica esperada.

- **Normalidad (p = 0.2325)**: Confirma distribución normal de errores, validando intervalos de confianza.

- **Sesgo (media = 2.352 mm)**: Leve subestimación, sin comprometer la calidad de pronósticos.

**Conclusión:** SARIMA presenta **desempeño equivalente** a Holt-Winters (MAE ≈ 4 mm). Ambas metodologías son igualmente apropiadas para pronósticos de precipitación en Cali. SARIMA ofrece **fundamentación estadística rigurosa** (Box-Jenkins) y modelado explícito de autocorrelación, mientras HW ofrece mayor simplicidad interpretativa.

## Diagnóstico de Errores de Pronóstico

```{r diagnostico-errores-sarima, fig.width=12, fig.height=8}
par(mfrow = c(2, 2))

# 1. Serie temporal de errores
plot(datos_forecast_sarima$Fecha, errores_sarima, type = "b", 
     main = "Errores de Pronóstico a lo Largo del Tiempo",
     xlab = "Fecha", ylab = "Error (mm)", col = "red", pch = 19)
abline(h = 0, col = "gray40", lty = 2, lwd = 2)
grid()

# 2. Histograma de errores
hist(errores_sarima, breaks = 8, col = "pink", border = "red",
     main = "Distribución de Errores de Pronóstico",
     xlab = "Error (mm)", ylab = "Frecuencia")
abline(v = 0, col = "darkred", lty = 2, lwd = 2)
abline(v = mean(errores_sarima), col = "darkblue", lty = 2, lwd = 2)
legend("topright", legend = c("Cero", "Media"), 
       col = c("darkred", "darkblue"), lty = 2, lwd = 2)

# 3. Q-Q plot de errores
qqnorm(errores_sarima, main = "Q-Q Plot de Errores de Pronóstico", 
       pch = 19, col = "red")
qqline(errores_sarima, col = "darkred", lwd = 2)

# 4. ACF de errores
acf(errores_sarima, main = "ACF de Errores de Pronóstico", 
    col = "red", lwd = 2)

par(mfrow = c(1, 1))
```

**Interpretación de los diagnósticos:**

Los gráficos de diagnóstico de SARIMA muestran un comportamiento **muy similar** al observado en Holt-Winters, confirmando que ambos modelos capturan adecuadamente la estructura temporal de la serie:

1. **Serie temporal de errores**: Al igual que en Holt-Winters, los errores fluctúan aleatoriamente alrededor de cero sin tendencias sistemáticas. Ambos modelos extraen exitosamente la información predecible de la serie histórica.

2. **Distribución de errores (histograma)**: Presenta simetría comparable a HW, con la media (línea azul) prácticamente coincidente con cero (línea roja), confirmando ausencia de sesgo en ambos modelos.

3. **Q-Q Plot**: La alineación de puntos sobre la diagonal es similar en ambos modelos, validando normalidad aproximada. Pequeñas desviaciones en las colas son aceptables en muestras pequeñas (n=12).

4. **ACF de errores**: **Todas las barras están dentro de las bandas azules** (límites al 95%), igual que en Holt-Winters. Esto confirma que tanto SARIMA como HW capturan completamente la autocorrelación temporal, dejando errores independientes.

**Comparación entre modelos**: Los diagnósticos de SARIMA y Holt-Winters son prácticamente idénticos, validando que ambas metodologías cumplen con los supuestos estadísticos fundamentales (residuos independientes, varianza constante, normalidad). No hay diferencias sustanciales en la calidad del ajuste entre ambos modelos para esta serie específica.