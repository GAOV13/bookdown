# Comparación de Modelos {#comparacion}

En este capítulo se realiza una **comparación integral** de los tres enfoques de pronóstico aplicados a la precipitación mensual en Cali:

1. **Holt-Winters** (Capítulo \@ref(holt-winters)): Suavizamiento exponencial
2. **SARIMA** (Capítulo \@ref(sarima)): Modelo estocástico Box-Jenkins
3. **Prophet** (Capítulo \@ref(prophet)): Modelo aditivo generalizado (regresión)

El objetivo es evaluar cuál método ofrece el mejor desempeño para este caso específico, considerando métricas cuantitativas, interpretabilidad y aplicabilidad práctica.

## Introducción: Tres Paradigmas

Cada modelo representa una **filosofía distinta** para abordar series temporales:

### Holt-Winters: Suavizamiento Exponencial

Utiliza promedios ponderados con pesos que decaen exponencialmente para capturar nivel, tendencia y estacionalidad. **Ventajas**: Simplicidad, rápido cómputo, efectivo para patrones estacionales estables. **Limitaciones**: Intervalos de confianza menos rigurosos, sensible a autocorrelación compleja.

### SARIMA: Modelado Estocástico

Modela la serie como proceso autorregresivo y de medias móviles con componentes estacionales. **Ventajas**: Base estadística rigurosa (Box-Jenkins), captura dependencias temporales complejas. **Limitaciones**: Requiere identificación de órdenes, sensible a outliers, coeficientes técnicos.

### Prophet: Regresión Aditiva

Descompone la serie en componentes sumables (tendencia + estacionalidad + error) como regresión. **Ventajas**: Componentes interpretables, robusto a datos irregulares, fácil incorporación de regresores externos. **Limitaciones**: Menor fundamentación teórica tradicional, requiere ajuste de hiperparámetros.

**Nota**: Todos los modelos fueron ajustados en el Capítulo \@ref(preparacion). Los objetos `hw_model`, `sarima_model`, `prophet_model` y sus métricas están disponibles directamente.

## Resumen de Modelos Ajustados

```{r resumen-modelos-comparacion}
cat("=== MODELOS PARA COMPARACIÓN ===\n\n")
cat("1. HOLT-WINTERS\n")
cat("   Parámetros: α =", round(hw_model$alpha, 4), 
    "| β =", round(hw_model$beta, 4),
    "| γ =", round(hw_model$gamma, 4), "\n\n")

cat("2. SARIMA\n")
orden <- arimaorder(sarima_model)
if(length(orden) >= 6) {
  cat("   Orden: SARIMA(", orden[1], ",", orden[2], ",", orden[3], 
      ")(", orden[4], ",", orden[5], ",", orden[6], ")[12]\n\n", sep="")
} else {
  cat("   Orden: ARIMA(", orden[1], ",", orden[2], ",", orden[3], ")\n\n", sep="")
}

cat("3. PROPHET\n")
cat("   Changepoints detectados:", length(prophet_model$changepoints), "\n")
cat("   Modo: Aditivo | Estacionalidad: Fourier anual\n\n")
```

## Tabla Comparativa de Métricas

```{r tabla-metricas, results='asis'}
# Crear tabla de resultados
metricas_comparacion <- data.frame(
  Modelo = c("Holt-Winters", "SARIMA", "Prophet"),
  MAE = c(MAE_hw, MAE_sarima, MAE_prophet),
  RMSE = c(RMSE_hw, RMSE_sarima, RMSE_prophet),
  `Cobertura IC (%)` = c(cobertura_hw, cobertura_sarima, cobertura_prophet),
  check.names = FALSE
)

# Mostrar tabla formateada
knitr::kable(
  metricas_comparacion,
  digits = c(0, 3, 3, 1),
  caption = "Comparación de métricas de pronóstico para 1998 (12 meses)",
  align = c('l', 'r', 'r', 'r')
)

cat("\n\n")

# Resumen de rankings
cat("=== RANKINGS POR MÉTRICA (1 = Mejor) ===\n\n")

cat("Error Absoluto Medio (MAE):\n")
mae_ranking <- metricas_comparacion %>% arrange(MAE) %>% select(Modelo, MAE)
for(i in 1:nrow(mae_ranking)) {
  cat("  ", i, ". ", mae_ranking$Modelo[i], " - ", round(mae_ranking$MAE[i], 3), " mm\n", sep = "")
}

cat("\nRaíz del Error Cuadrático Medio (RMSE):\n")
rmse_ranking <- metricas_comparacion %>% arrange(RMSE) %>% select(Modelo, RMSE)
for(i in 1:nrow(rmse_ranking)) {
  cat("  ", i, ". ", rmse_ranking$Modelo[i], " - ", round(rmse_ranking$RMSE[i], 3), " mm\n", sep = "")
}

cat("\nCobertura del Intervalo de Confianza (95%):\n")
cobertura_ranking <- metricas_comparacion %>% arrange(desc(`Cobertura IC (%)`)) %>% select(Modelo, `Cobertura IC (%)`)
for(i in 1:nrow(cobertura_ranking)) {
  cat("  ", i, ". ", cobertura_ranking$Modelo[i], " - ", round(cobertura_ranking$`Cobertura IC (%)`[i], 1), "%\n", sep = "")
}

# Identificar ganador general basado en MAE y RMSE
mejor_mae <- metricas_comparacion$Modelo[which.min(metricas_comparacion$MAE)]
mejor_rmse <- metricas_comparacion$Modelo[which.min(metricas_comparacion$RMSE)]

cat("\n>>> MEJORES DESEMPEÑOS <<<\n")
cat("  MAE:", mejor_mae, "\n")
cat("  RMSE:", mejor_rmse, "\n")
```

**Interpretación de las métricas:**

Los tres modelos presentan desempeños **prácticamente idénticos**:

**Error Absoluto Medio (MAE):**
- Holt-Winters: 4.016 mm | SARIMA: 4.067 mm | Prophet: 4.171 mm
- Diferencias < 0.2 mm (insignificantes). Todos representan 3-4% de error sobre la precipitación típica.

**Raíz del Error Cuadrático Medio (RMSE):**
- Holt-Winters: 4.585 mm | Prophet: 4.81 mm | SARIMA: 5.036 mm
- Diferencias < 0.5 mm. Relación RMSE/MAE (1.14-1.24) confirma ausencia de errores atípicos extremos.

**MAPE:** Valores no confiables (Inf%, 383%, 353%) por división entre valores cercanos a cero. **Métrica descartada**.

**Cobertura IC 95%:**
- Holt-Winters: 100% | Prophet: 100% | SARIMA: 91.7%
- Los tres cuantifican adecuadamente la incertidumbre.

**Normalidad de errores:**
- Holt-Winters: p=0.47 | SARIMA: p=0.23 | Prophet: p=0.44
- Los tres confirman normalidad (p > 0.05), validando intervalos de confianza.

**Sesgo:**
- Holt-Winters: ≈0 mm | SARIMA: 2.35 mm | Prophet: 1.78 mm
- Sesgos mínimos (< 2.5 mm), sin comprometer pronósticos.

**Conclusión:** **No hay ganador claro**. Las diferencias son insignificantes desde el punto de vista práctico. Los tres métodos son igualmente apropiados para pronósticos de precipitación en Cali. La elección debe basarse en criterios cualitativos: **Interpretabilidad** (Prophet > HW > SARIMA), **Fundamentación estadística** (SARIMA > HW > Prophet), **Facilidad** (HW > Prophet > SARIMA).

## Visualización Comparativa de Pronósticos

```{r grafico-comparacion-modelos, fig.width=14, fig.height=8}
# Crear dataframe largo para ggplot
fechas_test <- index(ts_test)
observados <- as.numeric(ts_test)

datos_graficos <- data.frame(
  Fecha = rep(fechas_test, 4),
  Valor = c(
    observados,
    hw_pred,
    sarima_pred,
    prophet_pred
  ),
  Tipo = rep(c("Observado", "Holt-Winters", "SARIMA", "Prophet"), each = length(fechas_test))
)

# Intervalos de confianza (como ribbons)
intervalos_df <- data.frame(
  Fecha = fechas_test,
  HW_lower = hw_lower,
  HW_upper = hw_upper,
  SARIMA_lower = sarima_lower,
  SARIMA_upper = sarima_upper,
  Prophet_lower = prophet_lower,
  Prophet_upper = prophet_upper
)

# Gráfico principal
ggplot(datos_graficos, aes(x = Fecha, y = Valor, color = Tipo, shape = Tipo)) +
  # Intervalos de confianza
  geom_ribbon(data = intervalos_df, 
              aes(x = Fecha, ymin = HW_lower, ymax = HW_upper),
              inherit.aes = FALSE, fill = "blue", alpha = 0.15) +
  geom_ribbon(data = intervalos_df,
              aes(x = Fecha, ymin = SARIMA_lower, ymax = SARIMA_upper),
              inherit.aes = FALSE, fill = "red", alpha = 0.15) +
  geom_ribbon(data = intervalos_df,
              aes(x = Fecha, ymin = Prophet_lower, ymax = Prophet_upper),
              inherit.aes = FALSE, fill = "green", alpha = 0.15) +
  # Líneas de pronóstico
  geom_line(aes(linetype = Tipo), linewidth = 1.0) +
  geom_point(size = 2.5) +
  # Escalas
  scale_color_manual(
    values = c(
      "Observado" = "black",
      "Holt-Winters" = "blue",
      "SARIMA" = "red",
      "Prophet" = "green"
    )
  ) +
  scale_shape_manual(
    values = c("Observado" = 19, "Holt-Winters" = 17, "SARIMA" = 15, "Prophet" = 18)
  ) +
  scale_linetype_manual(
    values = c("Observado" = "solid", "Holt-Winters" = "dashed", 
               "SARIMA" = "dotted", "Prophet" = "twodash")
  ) +
  # Etiquetas
  labs(
    title = "Comparación de Pronósticos: Holt-Winters vs. SARIMA vs. Prophet (1998)",
    subtitle = "Valores observados y predicciones con intervalos de confianza al 95%",
    x = "Fecha",
    y = "Precipitación (mm)",
    color = "Método",
    shape = "Método",
    linetype = "Método"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "bottom",
    legend.title = element_text(face = "bold")
  )
```

### Análisis Visual

Del gráfico anterior se observa:

**Similitud general:**
- Los tres modelos capturan el patrón estacional bimodal
- Picos en abril-mayo y octubre-noviembre bien identificados
- Diferencias sutiles entre pronósticos

**Intervalos de confianza:**
- Prophet: Intervalos más amplios (más conservadores)
- SARIMA: Intervalos intermedios
- Holt-Winters: Intervalos más estrechos

**Desviaciones notables:**
- Meses con mayor discrepancia entre modelos: Marzo, Julio
- Todos los modelos capturan razonablemente la temporada seca (julio-agosto)

## Comparación Conceptual

```{r tabla-conceptual, results='asis'}
comparacion_conceptual <- data.frame(
  Aspecto = c(
    "Paradigma",
    "Manejo de tendencia",
    "Modelado de estacionalidad",
    "Interpretabilidad",
    "Fundamentación teórica"
  ),
  `Holt-Winters` = c(
    "Suavizamiento exponencial",
    "Tendencia lineal suavizada",
    "Factores estacionales aditivos",
    "Alta (componentes claros)",
    "Estadística descriptiva"
  ),
  SARIMA = c(
    "Proceso estocástico",
    "Diferenciación (d, D)",
    "AR/MA estacional con periodo 12",
    "Moderada (coeficientes técnicos)",
    "Teoría probabilística rigurosa (Box-Jenkins)"
  ),
  Prophet = c(
    "Regresión aditiva (GAM)",
    "Piecewise linear con changepoints",
    "Series de Fourier flexibles",
    "Muy alta (componentes visuales)",
    "Regresión bayesiana"
  ),
  check.names = FALSE
)

knitr::kable(
  comparacion_conceptual,
  caption = "Comparación conceptual de los tres enfoques",
  align = c('l', 'l', 'l', 'l')
)
```